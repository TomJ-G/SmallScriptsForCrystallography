<# 
.SYNOPSIS
    The purpose of this script is to automate importing data from SPring-8 format to CrysAlisPro (CAP).
.DESCRIPTION
    The basic functionality of the script is to read PHI.log, INF and TIFF files from target folder. 
    Information regarding experimental details and conditions and run parameters are read.
    PHI file is checked only once. First INF file of EVERY run is checked. Number of runs is determined from PHI
    while number of frames in run is determined from INF. Run parameters are taken from PHI.
    Script can additionally unzip archive if 7z is installed and added to environment PATH variable.
.PARAMETER Base_path
    The path to the folder in which PHI.log, TIFF and INF files are stored.
.PARAMETER LiteralPath
    Name of the experiment, which is stored in output rit2_ini file. While this parameter is mandatory
    CAP is not reading it from rit2_ini, and need to be input again in CAP.
.EXAMPLE
    C:\PS> Prepare -Base_path "C:\Experimental data\compound1\100K" -Name "test2"
    <Script will check for files in "..\100K" folder and experimental name will be "test2">
.NOTES
    Author: Tomasz J. Galica
    Date:   October 12, 2021    
#>


function Prepare{

    [CmdletBinding()]
    Param(
        #Path to files directory
        [parameter(Mandatory=$true,HelpMessage="Path to file in which phi.log, INF and TIFF files are stored")] 
        [string]$Base_path, 
        [parameter(Mandatory=$true,HelpMessage="Name of experimental set, to be used in rit2_ini file")]
        [string]$Name,
        #Type $True if you want to decompress
        [parameter(Mandatory=$false,HelpMessage="True if you want to unzip archive. Remember to put '$' before bool value")]
        [ValidateSet($True,$False)]
        [bool]$zip = $false 
        )
    
            
    #7zip extraction from gz archive
    if($zip -eq $True){
        #Check if 7z is enabled
        $A = $False
        Write-Host "Testing if 7z is enabled" -ForegroundColor Cyan
        try {7z|Out-Null
             $A=$?}
        catch {"Execution cannot be completed!!!"
                }
        finally{Write-Host "Test finished" -ForegroundColor Cyan}
    
        #Ectract if 7z is available
        if($A -eq $True)
            {Write-Host "Begin extraction" -ForegroundColor Cyan
            $Pth = Join-Path $Base_path -ChildPath '*.tif.gz'
            $op = "-o"+$Base_path
            7z e $Pth $op|Out-Null}

        #Check how many TIFF files are in the directory after unzipping        
        $Tiff_count = Get-ChildItem -Path $Base_path -Filter '*.tif' |Measure-Object
        Write-Host "Number of tiff file found $($Tiff_count.Count)" -ForegroundColor Cyan    
        }
    
    #Collect information from phi
    #Regex pattern for phi.log
    $pattern = "(-?\d+.\d+\s+)(-?\d+.\d+\s+)(-?\d+.\d+\s+)(-?\d+.\d+\s+)(-?\d+.\d+\s+)(-?\d+.\d+\s+)"
    Write-Host "Reading phi.log file" -ForegroundColor Cyan
    try {
        $File = Get-Content -Path (Join-Path $Base_path -ChildPath 'phi.log') -ErrorAction Stop     
    }
    catch {
        Write-Warning "ERROR READING PHI.LOG FILE!!! SCRIPT EXECUTION WILL BE TERMINATED"
        Return
    }
    finally{
        Write-Host "..."
    }
    
    Write-Host "`nRuns information:"
    Write-Host "OmegaS OmegaEnd   Time     Chi      Phi      2Theta "
    
    #Pre-declared arrays and number of runs
    $Nruns = 0
    $Omegas = @()
    $OmegaE = @()
    $Times = @()
    $Thetas = @()
    $Kappas = @()
    $Phis = @()
    $Steps = @()

    #I obtain number of frames from phi.log. It is later used for step calculation
    #$Nframes = [int](Get-Content -Path (Join-Path $Base_path -ChildPath 'phi.log') | Select-Object -First 8 |Select-Object -Last 1)

    foreach($line in $File)
        {
            if($line -match $pattern)
            {
                $Nruns += 1
                Write-Host $Matches.0
                $Omegas += $Matches.1
                $OmegaE += $Matches.2
                $Times += $Matches.3
                $Kappas += $Matches.4
                $Phis += $Matches.5
                $Thetas += $Matches.6
            }
        }
    
    #Reading INF file from SPring-8
    try { 
        Write-Host "`nReading INF file" -ForegroundColor Cyan
        $INFs = Get-ChildItem -Path $Base_path -Filter '*.inf' -ErrorAction Stop 
        $INFs[0].Name
        $Content = Get-Content -Path (Join-Path $Base_path -ChildPath $INFs[0].Name)|Where-Object { $_.Contains("HEADER_BYTES")}
    }
    catch {
        Write-Warning "ERROR READING INF FILE!!! SCRIPT EXECUTION WILL BE TERMINATED"
        Return
    }
    finally{Write-Host "..."}
    
    #CHECK INF FILE FOR 1ST FRAME OF EACH RUN! YOU KNOW THE NUMBER OF RUNS
    #GET NRUNS -> CHECK INF -> GET NFRAMES -> WRITE LAST FRAME NUMBER -> WRITE SUMMARY NUMBER

    $Content -match "(\d+)"|Out-Null
    $Head_bytes = $Matches.1
    
    $Content = Get-Content -Path (Join-Path $Base_path -ChildPath $INFs[0].Name)|Where-Object { $_.Contains("CCD_DETECTOR_DIMENSIONS")}
    $Content -match "(\d+)\s(\d+)"|Out-Null
    $Dx = $Matches.1
    $Dy = $Matches.2
    
    $Content = Get-Content -Path (Join-Path $Base_path -ChildPath $INFs[0].Name)|Where-Object { $_.Contains("OPTICS_TYPE")}
    $Content -match "\w+=(\w+)"|Out-Null
    $synch = $Matches.1
    
    $Content = Get-Content -Path (Join-Path $Base_path -ChildPath $INFs[0].Name)|Where-Object { $_.Contains("SATURATED_VALUE")}
    $Content -match "\w+=(\d+)"|Out-Null
    $ovf = $Matches.1
    
    $Content = Get-Content -Path (Join-Path $Base_path -ChildPath $INFs[0].Name)|Where-Object { $_.Contains("SCAN_WAVELENGTH")}
    $Content -match "\w+=(\d?.\d+)"|Out-Null
    $wv = $Matches.1
    
    $Content = Get-Content -Path (Join-Path $Base_path -ChildPath $INFs[0].Name)|Where-Object { $_.Contains("CCD_GONIO_VALUES")}
    $Content -match "\w+=\d+.\d+\s+\d+.\d+\s+\d+.\d+\s+\d+.\d+\s+\d+.\d+\s+(\d+.\d+)"|Out-Null
    $ddist = $Matches.1
    
    #CCD_SPATIAL_BEAM_POSITION=500.50 525.77;

    #Reading of TIFF file from SPring-8
    try {
        Write-Host "`nReading TIFF file" -ForegroundColor Cyan
        $TIFFs = Get-ChildItem -Path $Base_path -Filter '*.tif' -ErrorAction Stop 
        $TIFFS[0].Name
    }
    catch {
        Write-Warning "ERROR READING TIF FILE!!! SCRIPT EXECUTION WILL BE TERMINATED"
        Return
    }
    finally {
        Write-Host "..."
    }

    
    
    $Content = Get-Content -Path (Join-Path $Base_path -ChildPath $TIFFS[0].Name) -TotalCount 18|Where-Object { $_.Contains("Pixel_size")}
    $Content -match "(\w+e-\w+)"|Out-Null
    $px = [double]$Matches.1 *1000 #This is pixel size in mm!
    
    $Content = Get-Content -Path (Join-Path $Base_path -ChildPath $TIFFS[0].Name) -TotalCount 18|Where-Object { $_.Contains("CdTe sensor")}
    $Content -match "(\w+\.\w+)"|Out-Null
    $Thickness = [double]$Matches.1 * 1000 #This is thickness size in mm!
    
    
    Write-Host "Reading data finished" -ForegroundColor Green
    
    Write-Host "`nExperimental data:"
    Write-Host "Number of runs: $Nruns"
    Write-Host "Header bytes: $Head_bytes"
    Write-Host "Frame sizes: x=$Dx y=$Dy"
    Write-Host "Radiation source: $synch"
    Write-Host "Overflow value: $ovf"
    Write-Host "Wavelength: $wv nm"
    Write-Host "Detector distance: $ddist mm"
    Write-Host "Pixel size: $px mm"
    Write-Host "HPAD module thickness $Thickness mm`n"

####This part will genarate import file for CAP.
#Large part of following will contain just raw text. Some parts contain variables.
#1st part of file describes general experimental conditions.

$RunContent = ""
$NewContent = @"
[ESPERANTOIMPORTER]
einputtype=6
epixeltype=30
iskipheader=$Head_bytes
iimgwidth iimgheight=$Dx $Dy
ibx_esperantoimporter iby_esperantoimporter=0 0
inumofruns=$Nruns
cimgbasename=$Name
eimgrot_deg=90
iismirrorrot=1
dpixelsize_mm=$px
ddetxorigin ddetyorigin=524.500000 511.800000
doverflowmark iisoverflow=99999.000000 0
ewavelength dalpha1 dalpha2 dbeta dsynchwavelen_or_alpha12=100 0.709300 0.713590 0.632288 $wv
iissynchrotron_or_microed=1
ddetdist_mm=$ddist
ddvalue dpolarizfactor=3.354000 1.000000
iispixeldetector dpixdetthick_mm=1 $Thickness
dgain felectronsperadu_esperantoimporter=1.000000 1.000000
iisautogap lautogapvalue=0 -1
"@



#Check first and last frame of each run. 
#In the same loop Construct Run information
$NFrames = @()
$TotFrames = 0
$First_frame = @()
$Last_frame = @()

for($x=0; $x -lt $Nruns;$x+=1){
     Write-Host "First frame of run $($x+1) is: $($TIFFs[$TotFrames].Name)"
     $First_frame += Join-Path $Base_path -ChildPath $TIFFs[$TotFrames].Name
     
     $Content = Get-Content -Path (Join-Path $Base_path -ChildPath $INFs[$TotFrames].Name)|Where-Object { $_.Contains("SCAN_SEQ_INFO")}
     $Content -match "\d+\s+\d+\s+(\d+)"|Out-Null
     $Nframes += $Matches.1
     $TotFrames += $Matches.1

     Write-Host "Last frame of run $($x+1): $($TIFFs[$TotFrames-1].Name)"
     $Last_frame += Join-Path $Base_path -ChildPath $TIFFs[$TotFrames-1].Name

     $Steps += ([double]$OmegaE[$x] - [double]$Omegas[$x])/($Nframes[$x] -1)
     $digits = ([string]$Nframes[$x]).Length


#2nd part describes values for each run    
$RunContent += 
@"
`n[ESPERANTOIMPORTER_RUN_$x]
inumtraildig irundig=$digits 0
cpathfilextfirstimg=$($First_frame[$x])
cpathlastimg=$($Last_frame[$x])
cpathmasterfile_hdf5=
cseparator=
ishowscanoptions=1
irunnum ifirstframenum ilastframenum inumofframes=$($x+1) 1 $($Nframes[$x]) $($Nframes[$x])
iisinverseorderofframes=1
dalphainst_deg dbetainst_deg=90.000000 0.000000
domega0inst_deg dtheta0inst_deg dkappa0inst_deg=0.000000 0.000000 0.000000
dbeamorient=0.000000
escantype=23
domegascan_deg dthetascan_deg dkappascan_deg dphiscan_deg=$($omegas[$x]) $(-$Thetas[$x]) $($Kappas[$x]) $($Phis[$x])
dscanstart_deg dscanstep_ideal_deg dexposuretimesec=0.000000 $($steps[$x]) $($Times[$x])
iisgeofile_for_sapphireformat=0
cgeopathfilext_for_sapphireformat=
iisscanaxiserror dscanaxiserror=0 0.000000
dd1inst_deg dd2inst_deg=0.000000 0.000000
"@    
}

#3rd part describes some binary information.
#I have no documentation on this part, so I just checked other imported data and copied the values.
#I checked if "0" would be accepted the same as "000000...". It is necesarly to keep all the zeros...
#Some parts of binary contained over 300 repeating lines. To increase readability, these lines will be now generated with for loop.
$Binary = @"
`n[ESPERANTOIMPORTER_binary]
siformatsheader_first_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
siformatsheader_first_1=00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
siformatsheader_last_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
siformatsheader_last_1=00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_scurpar_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_scurpar_1=0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sgeneralpar_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sgeneralpar_1=0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sspecialpar_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sspecialpar_1=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sspecialpar_2=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_smemorypar_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sgoniopar_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sgoniopar_1=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sgoniopar_2=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sgoniopar_3=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sstatisticspar_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sstatisticspar_1=00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
"@
for($j=0;$j -lt 320;$j+=1)
{
$Binary +="`nsformatimage_first_swindowmapstatistics_$j=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
}
$Binary += @"
`nsformatimage_first_swindowmapstatistics_320=00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_simagehistory_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_simagehistory_1=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_simagehistory_2=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_simagehistory_3=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_simagehistory_4=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_simagehistory_5=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_simagehistory_6=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_simagehistory_7=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sextra_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sextra_1=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sextra_2=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sextra_3=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sextra_4=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_sextra_5=00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_first_ssupplement_0=000000000000000000000000000000000000
sformatimage_last_scurpar_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_scurpar_1=0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sgeneralpar_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sgeneralpar_1=0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sspecialpar_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sspecialpar_1=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sspecialpar_2=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_smemorypar_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sgoniopar_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sgoniopar_1=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sgoniopar_2=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sgoniopar_3=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sstatisticspar_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sstatisticspar_1=00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
"@

for($j=0;$j -lt 320;$j+=1)
{
$Binary += "`nsformatimage_last_swindowmapstatistics_$j=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
}
$Binary += @"
`nsformatimage_last_swindowmapstatistics_320=00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_simagehistory_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_simagehistory_1=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_simagehistory_2=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_simagehistory_3=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_simagehistory_4=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_simagehistory_5=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_simagehistory_6=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_simagehistory_7=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sextra_0=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sextra_1=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sextra_2=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sextra_3=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sextra_4=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_sextra_5=00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
sformatimage_last_ssupplement_0=000000000000000000000000000000000000
"@

$NewContent = $NewContent + $RunContent + $Binary  
$TS_name = Get-Date -Format "yy-MM-dd__HHmmss"
$TS_name = $TS_name + "auto_out.rit2_ini"
try{
New-Item (Join-Path $Base_path -ChildPath $TS_name ) -ItemType "file" -Value $NewContent -ErrorAction Stop|Out-Null
}
catch{
    Write-Warning "ERROR DURING OUT FILE CREATION!!! SCRIPT WILL BE TERMINATED"
    Return
}
Write-Host "$TS_name file was created, script finished succesfully" -ForegroundColor Green
}